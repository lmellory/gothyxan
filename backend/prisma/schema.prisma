generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum BudgetMode {
  CHEAPER
  PREMIUM
  CUSTOM
}

enum OutfitChannel {
  WEB
  MOBILE
  TELEGRAM
}

enum SubscriptionTier {
  FREE
  PREMIUM
}

enum CatalogSource {
  END
  LOCAL
}

model User {
  id                 String                  @id @default(cuid())
  email              String                  @unique
  passwordHash       String
  name               String?
  role               Role                    @default(USER)
  subscriptionTier   SubscriptionTier        @default(FREE)
  referralCode       String?                 @unique
  referredByCode     String?
  isEmailVerified    Boolean                 @default(false)
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt
  verificationCodes  EmailVerificationCode[]
  passwordResetCodes PasswordResetCode[]
  refreshTokens      RefreshToken[]
  outfitLogs         OutfitGenerationLog[]
  savedOutfits       SavedOutfit[]
  styleProfile       UserStyleProfile?
  subscription       UserSubscription?
  generationUsage    GenerationUsageDaily[]
  referralSent       ReferralEvent[]         @relation("ReferralSent")
  referralReceived   ReferralEvent[]         @relation("ReferralReceived")
  affiliateClicks    AffiliateClick[]
  auditLogs          AuditLog[]
}

model EmailVerificationCode {
  id         String   @id @default(cuid())
  userId     String
  codeHash   String
  expiresAt  DateTime
  attempts   Int      @default(0)
  consumedAt DateTime?
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
}

model PasswordResetCode {
  id         String   @id @default(cuid())
  userId     String
  codeHash   String
  expiresAt  DateTime
  attempts   Int      @default(0)
  consumedAt DateTime?
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String
  userAgent String?
  ipAddress String?
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
}

model Brand {
  id         String     @id @default(cuid())
  name       String     @unique
  tier       Int
  isActive   Boolean    @default(true)
  categories String[]
  styleTags  String[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  items      BrandItem[]
}

model BrandItem {
  id             String   @id @default(cuid())
  brandId        String
  name           String
  category       String
  estimatedPrice Int
  tier           Int
  styleTags      String[]
  occasionTags   String[]
  referenceLink  String
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  brand          Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId, category])
  @@index([tier, estimatedPrice])
}

model FeaturedStyle {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isFeatured  Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model OutfitGenerationLog {
  id               String     @id @default(cuid())
  userId           String
  style            String
  occasion         String?
  weatherContext   String
  location         String
  budgetMode       BudgetMode
  budgetMin        Int?
  budgetMax        Int?
  totalPrice       Int
  outputJson       Json
  validationPassed Boolean    @default(true)
  explanation      String?
  createdAt        DateTime   @default(now())
  user             User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([style, createdAt])
  @@index([createdAt])
}

model SavedOutfit {
  id        String       @id @default(cuid())
  userId    String
  channel   OutfitChannel
  outfitJson Json
  createdAt DateTime     @default(now())
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([createdAt])
}

model ExternalCatalogItem {
  id         String        @id @default(cuid())
  source     CatalogSource @default(END)
  brand      String
  category   String
  title      String
  price      Int?
  currency   String?
  productUrl String        @unique
  imageUrl   String
  styleTags  String[]
  isActive   Boolean       @default(true)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  @@index([source, brand, category, isActive])
  @@index([isActive, category, price])
}

model UserStyleProfile {
  id                  String     @id @default(cuid())
  userId              String     @unique
  generationCount     Int        @default(0)
  preferredBudgetMode BudgetMode?
  avgBudgetMin        Int?
  avgBudgetMax        Int?
  lastStyle           String?
  favoriteBrands      String[]
  styleStats          Json       @default("{}")
  brandStats          Json       @default("{}")
  lastGeneratedAt     DateTime?
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt
  user                User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([lastStyle])
  @@index([updatedAt])
}

model UserSubscription {
  id                   String           @id @default(cuid())
  userId               String           @unique
  tier                 SubscriptionTier @default(FREE)
  status               String           @default("active")
  unlimitedGenerations Boolean          @default(false)
  luxuryOnlyEnabled    Boolean          @default(false)
  dailyGenerationLimit Int              @default(20)
  monthlyGenerationLimit Int            @default(300)
  startsAt             DateTime         @default(now())
  endsAt               DateTime?
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  user                 User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tier, status])
}

model GenerationUsageDaily {
  id        String   @id @default(cuid())
  userId    String
  day       DateTime
  count     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, day])
  @@index([day, count])
}

model ReferralEvent {
  id            String   @id @default(cuid())
  referrerUserId String
  refereeUserId  String
  referralCode  String
  rewardCredits Int      @default(0)
  createdAt     DateTime @default(now())
  referrer      User     @relation("ReferralSent", fields: [referrerUserId], references: [id], onDelete: Cascade)
  referee       User     @relation("ReferralReceived", fields: [refereeUserId], references: [id], onDelete: Cascade)

  @@unique([refereeUserId])
  @@index([referrerUserId, createdAt])
}

model AffiliateClick {
  id              String       @id @default(cuid())
  userId          String?
  channel         OutfitChannel?
  itemBrand       String?
  itemName        String?
  targetUrl       String
  affiliateUrl    String?
  commissionCents Int          @default(0)
  createdAt       DateTime     @default(now())
  user            User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([userId, createdAt])
}

model ImageValidationLog {
  id         String   @id @default(cuid())
  sourceUrl  String
  success    Boolean
  statusCode Int?
  reason     String?
  latencyMs  Int?
  createdAt  DateTime @default(now())

  @@index([createdAt, success])
}

model AuditLog {
  id         String   @id @default(cuid())
  actorUserId String?
  action     String
  entityType String
  entityId   String?
  payload    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  actor      User?    @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([actorUserId, createdAt])
}
